{#{% extends 'ZikulaFormExtensionBundle:Form:bootstrap_3_zikula_admin_layout.html.twig' %}#}
{# user live search input widget #}
{% block zikulausersmodule_userlivesearch_widget %}
    
    {%  set selectorId=id %}
    
    <div id="{{ selectorId }}_box" class="autocomplete-user">
        <noscript><p>{{ __('This function requires JavaScript activated!') }}</p></noscript>
        <input type="hidden" {{ block('widget_attributes') }} value="{{ value }}" />
        <div class="form-group">
          <div class="input-group">
{#            <div class="input-group-addon">
                <span id="{{ selectorId }}_avatar" class="help-block avatar">
                {% if value %}
                    {{ userAvatar(value, { class: 'g' }) }} 
                {% endif %}
                </span>
            </div>#}
            <div class="input-group-btn">
                <button class="btn btn-default {{ btn_size|default(' ') }}" type="button">
                    <i class="fa fa-search" title="{{ __('Enter a part of the user name to search') }}"></i>
                </button>
            </div>
{#            <div class="input-group-addon"><i class="fa fa-search" title="{{ __('Enter a part of the user name to search') }}"></i></div>#}
            <input type="text" 
                   id="{{ selectorId }}_field" 
                   name="{{ selectorId }}_field" 
                   autocomplete="off" 
                   value="{{ user_name|e('html_attr') }}" 
                   title="{{ __('Enter a part of the user name to search') }}" 
                   class="form-control user-selector" />
            <label for="{{ selectorId }}_field"> {{ __('Author') }}</label>
            {% if not required %}
                <div class="input-group-btn">
                    <a id="{{ selectorId }}_reset" href="javascript:void(0);" class="btn btn-default {{ btn_size|default(' ') }} hidden">
                    <i class="fa fa-eraser" title="{{ __('Reset to empty value') }}"></i>
                    </a>
                </div>
{#            <div class="input-group-addon">
                <a id="{{ selectorId }}ResetVal" href="javascript:void(0);" class="hidden">
                <i class="fa fa-eraser" title="{{ __('Reset to empty value') }}"></i>
                </a>
            </div>#}
            {% endif %}
            </div>
        </div>
    </div>
            
            
{#    {% if not required %}
        <span class="help-block"><a id="{{ selectorId }}_reset" href="javascript:void(0);" class="hidden">{{ __('Reset to empty value') }}</a></span>
    {% endif %}#}
    {% if value and not inline_usage %}
        {% if hasPermission('ZikulaUsersModule::', '::', 'ACCESS_ADMIN') %}
            <span class="help-block"><a href="{{ path('zikulausersmodule_useradministration_modify', { 'user': value }) }}" title="{{ __('Switch to users administration') }}">{{ __('Manage user') }}</a></span>
        {% endif %}
    {% endif %}
    {% set formInitScript %}
        <script type="text/javascript">
            /* <![CDATA[ */
            (function ($) {
                $(document).ready(function () {
                        // initialise auto completion for user fields
                        initUserLiveSearch('{{ selectorId }}');
                    });
                })(jQuery);
                /* ]]> */
        </script>
    {% endset %}
    {% set formScript %}
        <script type="text/javascript">
            /**
             * Initialises a user field with auto completion.
             */
            function initUserLiveSearch(fieldName)
            {
                jQuery('#' + fieldName + '_reset').click( function (event) {
                    event.preventDefault();
                    jQuery('#' + fieldName).val('');
                    jQuery('#' + fieldName + '_field').val('');
                    jQuery('#' + fieldName + '_avatar').text('');
                }).removeClass('hidden');
                
                if (jQuery('#' + fieldName + '_box').length < 1) {
                    return;
                }
                
                jQuery('#' + fieldName + '_box').removeClass('hidden');
                jQuery('#' + fieldName + '_field').autocomplete({
                    minLength: 1,
                    open: function(event, ui) {
                        jQuery(this).autocomplete('widget').css({
                            width: (jQuery(this).outerWidth() + 'px')
                        });
                    },
                    source: function (request, response) {
                        jQuery.getJSON(Routing.generate('zikulausersmodule_livesearch_getusers', { fragment: request.term }), function(data) {
                            response(data);
                        });
                    },
                    response: function(event, ui) {
                        jQuery('#' + fieldName + '_box .empty-message').remove();
                        if (ui.content.length === 0) {
                            jQuery('#' + fieldName + '_box').append(
                                jQuery('<div />', { class: 'empty-message' }).text(Translator.__('No results found!'))
                            );
                        }
                    },
                    focus: function(event, ui) {
                        jQuery('#' + fieldName + '_field').val(ui.item.uname);

                        return false;
                    },
                    select: function(event, ui) {
                        jQuery('#' + fieldName).val(ui.item.uid);
                        jQuery('#' + fieldName + '_avatar').html(ui.item.avatar);

                        return false;
                    }
                })
                .autocomplete('instance')._renderItem = function(ul, item) {
                    return jQuery('<div />', { class: 'suggestion' })
                        .append('<div class="media"><div class="media-left"><a href="javascript:void(0)">' + item.avatar + '</a></div><div class="media-body"><p class="media-heading">' + item.uname + '</p></div></div>')
                        .appendTo(ul);
                };
            }
        </script>
    {% endset %}
    {% set formCss %}
        <style>
        {#{{ pageAddAsset('javascript', zasset('@ZikulaUsersModule:js/Zikula.Users.LiveSearch.js')) }}#}
        .ui-autocomplete {
            max-height: 150px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        * html .ui-autocomplete {
            height: 150px;
        }

        .ui-autocomplete-loading {
{#            background: white url('../images/indicator_arrows.gif') right center no-repeat;#}
        }

        .ui-autocomplete .suggestion {
            margin: 0;
            padding: 0.2em 0 0.2em 20px;
            list-style-type: none;
            line-height: 1.4em;
            cursor: pointer;
            display: block;
            background-position: 2px 2px;
            background-repeat: no-repeat;
            background-color: #fff;
        }

        .ui-autocomplete .suggestion {
{#            background-image: url('../images/user.png');#}
        }
        .ui-autocomplete .suggestion img {
            max-width: 20px;
            max-height: 20px;
        }

        .ui-autocomplete .suggestion .ui-state-active {
            background-color: #ffb;
        }

        .ui-autocomplete .suggestion .media-body {
            font-size: 10px;
            color: #888;
        }
        .ui-autocomplete .suggestion .media-body .media-heading {
            font-size: 12px;
            line-height: 1.2em;
        }
        .ui-autocomplete .suggestion {
            background-image: none;
        }
        .ui-autocomplete .suggestion {
            margin: 0;
            padding: 0.2em 0 0.2em 5px;
            list-style-type: none;
            line-height: 1.4em;
            cursor: pointer;
            display: block;
            background-position: 2px 2px;
            background-repeat: no-repeat;
            background-color: #fff;
        }
        </style>
    {% endset %}
{{ pageAddAsset('stylesheet', asset('jquery-ui/themes/base/jquery-ui.min.css')) }}
{{ pageAddAsset('javascript', asset('jquery-ui/jquery-ui.min.js')) }}
{{ pageAddAsset('footer', formScript) }}
{{ pageAddAsset('footer', formInitScript) }}
{{ pageAddAsset('header', formCss) }}
{% endblock %}

